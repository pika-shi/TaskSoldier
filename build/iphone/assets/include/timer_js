(function(){app.timer={};app.timer.createWindow=function(taskID,caller){var timerWin=Ti.UI.createWindow({title:'timer',backgroundImage:'back.jpg'});var messageView=Ti.UI.createImageView({center:{x:Ti.Platform.displayCaps.platformWidth/2+'dp',y:50+'dp'},width:Ti.Platform.displayCaps.platformWidth*0.7,height:'auto',touchEnabled:false});var baseView=Ti.UI.createView({center:{x:Ti.Platform.displayCaps.platformWidth/2+'dp',y:170+'dp'},backgroundColor:'#7fbfff',opacity:0.6,width:180+'dp',height:100+'dp'});var timerLabel=Ti.UI.createLabel({center:{x:Ti.Platform.displayCaps.platformWidth/2+'dp',y:170+'dp'},textAlign:'center',font:{fontSize:60,fontFamily:'Helvetica Neue'},color:'white',touchEnabled:false});var timeSet=(Ti.App.Properties.getString('timeset'))?Ti.App.Properties.getString('timeset'):25;var chosenTime;if(timeSet==25){chosenTime=new Array(25*60,5*60);}else if(timeSet==50){chosenTime=new Array(50*60,10*60);}
var section=0;var count=chosenTime[section];var totalTime=0;var myTimer;count=calcTime(count);function setTimer(){myTimer=setInterval(function(){count=calcTime(count);},1000);}
function stopTimer(option){clearInterval(myTimer);switch(option){case 0:confirmAlert.show();break;case 1:break;default:break;}}
function calcTime(second){var min=Math.floor(second/60);min=(min>9)?min:'0'+min;var sec=second%60;sec=(sec>9)?sec:'0'+sec;timerLabel.text=min+':'+sec;second--;if(second<0){section=(section==0)?1:0;second=chosenTime[section];genMessage(section);Ti.Media.vibrate();}else{totalTime++;}
return second;}
function genMessage(section){switch(section){case 0:messageView.image='messageImg/message'+(Math.floor(Math.random()*4)+1)+'.png';break;case 1:messageView.image='messageImg/message_rest.png';break;}}
var pauseFlag=0;var pauseButton=Ti.UI.createButton({backgroundImage:'button_pause.png',center:{x:Ti.Platform.displayCaps.platformWidth/2+'dp',y:300+'dp'},width:'150dp',height:'50dp'});pauseButton.addEventListener('click',function(e){switch(pauseFlag){case 0:pauseFlag=1;stopTimer(1);this.backgroundImage='button_resume.png';break;case 1:pauseFlag=0;setTimer();this.backgroundImage='button_pause.png';break;}});timerWin.addEventListener('blur',function(e){if(pauseFlag==0){stopTimer(1);var db=new TaskDB();db.updateCell(taskID,'passedtime',passedTime+totalTime);db.close();}});var finishButton=Ti.UI.createButton({backgroundImage:'button_exit.png',center:{x:Ti.Platform.displayCaps.platformWidth/2+'dp',y:370+'dp'},width:'150dp',height:'50dp'});finishButton.addEventListener('click',function(e){pauseFlag=1;pauseButton.backgroundImage='button_resume.png';stopTimer(0);});var confirmAlert=Ti.UI.createAlertDialog({title:'集中作業の終了',message:'タスクは完了しましたか?',buttonNames:['はい','いいえ','キャンセル'],cancel:2});confirmAlert.addEventListener('click',function(e){var db=new TaskDB();switch(e.index){case 0:var date=getDate();db.updateCell(taskID,'endtime',date);case 1:passedTime=db.fetchCell(taskID,'passedtime');if(typeof passedTime!=typeof 1){db.updateCell(taskID,'passedtime',totalTime);}else{db.updateCell(taskID,'passedtime',passedTime+totalTime);}
db.close();caller.close();timerWin.close();break;}});function getDate(){var date=new Date();var year=date.getYear();var mon=date.getMonth()+1;var day=date.getDate();var hour=date.getHours();var min=date.getMinutes();var sec=date.getSeconds();year=(year<2000)?year+1900:year;if(mon<10)mon="0"+mon;if(day<10)day="0"+day;if(hour<10)hour="0"+hour;if(min<10)min="0"+min;if(sec<10)sec="0"+sec;return year+"-"+mon+"-"+day+" "+hour+":"+min+":"+sec;}
function showCountDown(){var blackView=Ti.UI.createView({width:Ti.Platform.displayCaps.platformWidth,height:Ti.Platform.displayCaps.platformHeight,backgroundColor:'black'});var countLabel=Ti.UI.createLabel({center:{x:Ti.Platform.displayCaps.platformWidth/2+'dp',y:Ti.Platform.displayCaps.platformHeight/2+'dp'},textAlign:'center',font:{fontSize:200,fontFamily:'Helvetica Neue'},color:'white',touchEnabled:false});blackView.add(countLabel);timerWin.add(blackView);var count=3;myCount=setInterval(function(){if(count>0){countLabel.text=count;count--;}else{clearInterval(myCount);timerWin.remove(blackView);genMessage(section);drawTimer();setTimer();}},800);}
function drawTimer(){timerWin.add(baseView);timerWin.add(timerLabel);timerWin.add(pauseButton);timerWin.add(finishButton);timerWin.add(messageView);}
showCountDown();return timerWin;};})();