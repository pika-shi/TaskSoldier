(function(){app.tasklist={};app.tasklist.createTab=function(){var taskListWin=Ti.UI.createWindow({title:'タスク',backgroundImage:'back.jpg',barColor:'#B0C4DE'});var scrollView;tab=Ti.UI.createTab({icon:'task.png',title:'タスク',window:taskListWin});var button=Ti.UI.createButton({systemButton:Ti.UI.iPhone.SystemButton.ADD});button.addEventListener('click',function(){var addTaskWindow=app.addtask.createWindow();addTaskWindow.title="タスクの追加";tab.open(addTaskWindow);});var db=new TaskDB();records=db.fetchToList(0);var views;var prevPoint;var prevRadius;var initialY=30;function initialize(){views={};prevPoint={x:0,y:initialY};prevRadius=0;if(taskListWin.getChildren().length>0){taskListWin.remove(taskListWin.getChildren()[0]);}
scrollView=Ti.UI.createScrollView({contentWidth:'auto',contentHeight:'auto',top:0});taskListWin.add(scrollView);}
function getDate(){var date=new Date();var year=date.getYear();var mon=date.getMonth()+1;var day=date.getDate();var hour=date.getHours();var min=date.getMinutes();var sec=date.getSeconds();year=(year<2000)?year+1900:year;if(mon<10)mon="0"+mon;if(day<10)day="0"+day;if(hour<10)hour="0"+hour;if(min<10)min="0"+min;if(sec<10)sec="0"+sec;return year+"-"+mon+"-"+day+" "+hour+":"+min+":"+sec;}
function subDate(rec){var tmp=rec.deadline.split('-');var rYear=tmp[0];var rMonth=tmp[1];var rDay=tmp[2].split(' ')[0];var tmp2=tmp[2].split(' ')[1].split(':');var rHour=tmp2[0];var rMin=tmp2[1];var rSec=tmp2[2];var rDate=new Date(rYear,rMonth-1,rDay,rHour,rMin,rSec);var date=new Date();return(rDate.getTime()-date.getTime())/1000;}
function nextPnt(prevPnt,prevRad,nextRad){var x=prevPnt.x;var nextX=0;var y=prevPnt.y;var nextY=0;if(x==0){while(nextX+nextRad>Ti.Platform.displayCaps.platformWidth||nextX-nextRad<0){nextX=Ti.Platform.displayCaps.platformWidth*Math.random();}}else{var count=0;while(Math.abs(nextX-x)<prevRad+nextRad||nextX+nextRad>Ti.Platform.displayCaps.platformWidth||nextX-nextRad<0){count++;if(count>1000){while(nextX+nextRad>Ti.Platform.displayCaps.platformWidth||nextX-nextRad<0){nextX=Ti.Platform.displayCaps.platformWidth*Math.random();}
nextY=y+prevRad+nextRad;return{x:nextX,y:nextY};}else{nextX=Ti.Platform.displayCaps.platformWidth*Math.random();}}}
if(y==initialY){nextY=y+nextRad;}else{nextY=y+nextRad+prevRad*(Math.random()/2+0.5);}
return{x:nextX,y:nextY};}
function nextRad(rec){var last=subDate(rec)/(60*60*24);if(0<last&&last<1)return rec.importance*(15+5*(1-last))+25;else if(last<3)return rec.importance*(14+0.5*(3-last))+20;else if(last<7)return rec.importance*(10+0.5*(7-last))+20;else return rec.importance*8+20;}
function drawTasks(recs,showDialog){initialize();var excessRecords=new Array(0);var message='';for(var i=0;i<recs.length;i++){var rec=recs[i];var last=subDate(rec);if(last<-60*60*24*7){db.deleteTask(rec.id);}else if(last<0){excessRecords.push(rec);}else{if(showDialog==true&&last<60*60*6){message=message+rec.name+'\n';}
var next=addTask(rec,last,prevPoint,prevRadius);prevPoint=next.point;prevRadius=next.radius;}}
for(var i=excessRecords.length-1;i>=0;i--){var rec=excessRecords[i];var last=subDate(rec);var next=addTask(rec,last,prevPoint,prevRadius);prevPoint=next.point;prevRadius=next.radius;}
if(showDialog==true&&message.length>0){setTimeout(function(){Ti.Media.vibrate();Ti.UI.createAlertDialog({title:'締切が近付いています!!',message:message}).show();},100);}}
drawTasks(records,true);function addTask(rec,last,prevPnt,prevRad){var nextRadius=nextRad(rec);var nextPoint=nextPnt(prevPnt,prevRad,nextRadius);var img;if(last<0){img='./circleImg/g1.png';}else{img={1:'./circleImg/b1.png',2:'./circleImg/y1.png',3:'./circleImg/r1.png'}[rec.importance]}
var imageView=Ti.UI.createImageView({id:rec.id,name:rec.name,image:img,width:nextRadius*2+'dp',height:nextRadius*2+'dp',center:{x:nextPoint.x+'dp',y:nextPoint.y+'dp'},opacity:0.8});imageView.add(Ti.UI.createLabel({text:imageView.name,width:imageView.width,height:20,textAlign:'center',font:{fontSize:20,fontFamily:'Helvetica Neue'},color:'#555555',touchEnabled:false}));scrollView.contentHeight=nextPoint.y+nextRadius;scrollView.add(imageView);views[rec.id]=imageView;var touched=false;imageView.addEventListener('touchstart',function(e){touched=true;var img=e.source;var confirmAlert=Ti.UI.createAlertDialog({title:'タスク"'+img.name+'"を削除します．',message:'よろしいですか?',buttonNames:['はい','いいえ'],cancel:1});confirmAlert.addEventListener('click',function(e){switch(e.index){case 0:removeTaskImage(img.id);removeTask(img.id);break;case 1:break;}});setTimeout(function(){if(touched)confirmAlert.show();},1000);});imageView.addEventListener('touchend',function(e){touched=false;var taskDetailWindow=app.taskdetail.createWindow('tasklist',e.source.id);tab.open(taskDetailWindow);});imageView.addEventListener('touchmove',function(e){touched=false});return{point:nextPoint,radius:nextRadius};}
function removeTaskImage(id){var imgView=views[id];var imageIndex=1;var animationLength=16;var color=imgView.image.split('1')[0];var suffix=imgView.image.split('1')[1];var animate=setInterval(function(){imgView.image=color+imageIndex+suffix;imageIndex++;if(imageIndex>animationLength){clearInterval(animate);scrollView.remove(imgView);delete views[imgView.id];}},100);}
function removeTask(id){db.deleteTask(id);}
function exists(ele,index,array){return(this.indexOf(ele)==-1);}
var blurFlag=0;var prevRecords=new Array(0);taskListWin.addEventListener('blur',function(e){blurFlag=1;for(var i=0;i<records.length;i++){prevRecords.push(records[i].id);}});taskListWin.addEventListener('focus',function(e){records=db.fetchToList(0);var laterRecords=new Array(0);var tmp;if(blurFlag==1){for(var i=0;i<records.length;i++){laterRecords.push(records[i].id);}
var added=laterRecords.filter(exists,prevRecords)[0];var removed=prevRecords.filter(exists,laterRecords)[0];if(added!=null){drawTasks(records,false);}else if(removed!=null&&views[removed]!=null){removeTaskImage(removed);}
prevRecords=new Array(0);blurflag=0;}});Ti.App.addEventListener('resume',function(e){setTimeout(function(){drawTasks(db.fetchToList(0),true);},10);});taskListWin.setRightNavButton(button);return tab;};})();